<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[WIP]Work with ESP-IDF under Clion IDE | Notebin</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="Where my notes filled into">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.7084683f.js" as="script"><link rel="preload" href="/assets/js/2.c61553e1.js" as="script"><link rel="preload" href="/assets/js/3.27e6ffee.js" as="script"><link rel="prefetch" href="/assets/js/10.5cdaa53b.js"><link rel="prefetch" href="/assets/js/11.d15338d5.js"><link rel="prefetch" href="/assets/js/12.689626df.js"><link rel="prefetch" href="/assets/js/13.d1eb2323.js"><link rel="prefetch" href="/assets/js/4.7b5f4583.js"><link rel="prefetch" href="/assets/js/5.56fc75eb.js"><link rel="prefetch" href="/assets/js/6.69cb71d3.js"><link rel="prefetch" href="/assets/js/7.07a08317.js"><link rel="prefetch" href="/assets/js/8.53812138.js"><link rel="prefetch" href="/assets/js/9.06c22ac6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Notebin</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Me</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Openwrt</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Pilotpi</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Esp32</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/esp32/work_with_clion.html" aria-current="page" class="active sidebar-link">[WIP]Work with ESP-IDF under Clion IDE</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/esp32/work_with_clion.html#before-the-beginning" class="sidebar-link">Before the beginning</a></li><li class="sidebar-sub-header"><a href="/esp32/work_with_clion.html#setup-idf-enabled-clion" class="sidebar-link">Setup IDF-enabled Clion</a></li><li class="sidebar-sub-header"><a href="/esp32/work_with_clion.html#open-the-hello-world-project" class="sidebar-link">Open the hello world project</a></li><li class="sidebar-sub-header"><a href="/esp32/work_with_clion.html#developing-chips-other-than-esp32" class="sidebar-link">Developing chips other than ESP32</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Notes</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="wip-work-with-esp-idf-under-clion-ide"><a href="#wip-work-with-esp-idf-under-clion-ide" class="header-anchor">#</a> [WIP]Work with ESP-IDF under Clion IDE</h1> <p>Since IDF v4.0 cmake becomes part of the default toolchain, make it quite convenient to develop native esp32 (and further c3, s3) projects with modern IDE like Clion. This could be a great news for newcomers from CS (not EE) like me, to get full assistant from IDE while developing embedded projects.</p> <p>No extra plugins is needed. Just a few cmake flags need to be cared about manually.</p> <h2 id="before-the-beginning"><a href="#before-the-beginning" class="header-anchor">#</a> Before the beginning</h2> <h4 id="this-article-will-cover-the-following-parts"><a href="#this-article-will-cover-the-following-parts" class="header-anchor">#</a> This article will cover the following parts</h4> <ul><li>Run Clion within ESP-IDF enabled environment</li> <li>Load and build an esp32 example project in Clion</li> <li>Configure the project for esp32c3/s3 target and works with Clion</li> <li>Load and build unit-test-app</li></ul> <h4 id="currently-not-covered"><a href="#currently-not-covered" class="header-anchor">#</a> Currently not covered</h4> <ul><li>flash and monitor inside Clion</li> <li>OpenOCD debug</li></ul> <h4 id="assumed-condition"><a href="#assumed-condition" class="header-anchor">#</a> Assumed condition</h4> <ul><li>You are on the latest Linux Mint / Ubuntu. Other deb based distributions should work. Arch users know what they need to do.</li> <li>Have ESP-IDF successfully installed and at least examples can be built and flashed from cli.</li></ul> <p>I strongly recommend to set the <code>get_idf</code> alias for convenience. It is not recommended to make IDF available for every console session as default, so at least we should be able to load IDF environment with command as short as possible.</p> <p>There is also some difference between different desktop environments. I'm on xfce.</p> <h4 id="check-again"><a href="#check-again" class="header-anchor">#</a> Check again</h4> <p>Now you should have cloned IDF repo and finished the install progress. You should also have Clion installed and works normally.</p> <p>For convenience, <code>get_idf</code> should also be set as an alias to load IDF specificed environment to current session.</p> <p>Make sure you can build any projects by following the <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/get-started/index.html#step-8-build-the-project" target="_blank" rel="noopener noreferrer">official guide<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="setup-idf-enabled-clion"><a href="#setup-idf-enabled-clion" class="header-anchor">#</a> Setup IDF-enabled Clion</h2> <p>If you ever tried to load IDF projects directly in Clion then cmake will complain about missing toolchains and will not succeed. That is because IDF related dependence is not included in your session which Clion launched from. There is a way to manually configure them out but is too complex and annoying so I personally never recommend that method. Another way is simply launching the Clion from a session where IDF is already available.</p> <p>Open a terminal and type <code>get_idf</code> to load IDF env, then locate where Clion is and launch it. It is expected to have Clion running under IDF now and cmake will automatically sort out everything when IDF projects are opened. No error should be there now!</p> <p>Not very convenient because everytime you should open a terminal at first, load IDF, and start Clion from command line. This step can also be simplified with the help of a simple bash script.</p> <p>Create a file under <code>~/.local/bin</code>, named <code>idfclion</code> with following commands:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/bin/bash
. /path/to/idf/export.sh
/path/to/clion.sh
EOF</span> <span class="token operator">&gt;</span> ~/.local/bin/idfclion
</code></pre></div><p>Where <code>/path/to/clion.sh</code> should be replace with true one on your system. The same for <code>/path/to/idf</code> . They should be absolute path. Note IDF path is the directory where you have cloned the esp-idf repo.</p> <p>Then make it executable:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">chmod</span> +x ~/.local/bin/idfclion
</code></pre></div><p>Now you should able to launch an IDF-enabled Clion with a single command <code>idfclion</code>.</p> <p>With this method no root permission is required and it only works for current user.</p> <p>Then I'd create a desktop entry for it. It differs with different desktop environment so please search and try it by yourself.</p> <p>Finally I got those two icons on my desktop</p> <p><img src="/assets/img/clion_and_with_idf.f5813d21.png" alt="desktop_icon"></p> <p>The first one for normal projects and the second one for IDF.</p> <h2 id="open-the-hello-world-project"><a href="#open-the-hello-world-project" class="header-anchor">#</a> Open the hello world project</h2> <p>So by now an IDF-enabled Clion is configured, next topic is how to use it.</p> <p>Switch to IDF repo directory(<code>$IDF_PATH</code>) and you will find the <code>examples</code> lying here. The directory <code>examples/get-started/hello_world/</code> contains a hello-world example ready to be tested.</p> <p>From Clion menubar choose &quot;Projects&quot; =&gt; &quot;Open&quot;, navigate to where hello-world project exists</p> <p><img src="/assets/img/locate_helloworld.47d96223.png" alt="locate_helloworld"></p> <p>Press OK. Then Choose &quot;Open as CMake project&quot;.</p> <p>On newer Clion it will ask to trust the project. To make everything works then click &quot;Trust Project&quot;.</p> <p>Now Clion will open a wizard to configure cmake profile. Those settings can also be changed later. To keep the same behavior as idf.py, we can fill the &quot;Build directory&quot; with <code>build</code>. Click &quot;OK&quot;. That's all.</p> <p><img src="/assets/img/clion_helloworld.c0c85da9.png" alt="clion_helloworld"></p> <p>You can build from menubar &quot;Build&quot; =&gt; &quot;Build Project&quot; to see if everything works.</p> <p>To flash the firmware onto device, you cannot directly use <code>idf.py</code> for that. Here we must manually switch to a new console and executing <code>make xxx</code> manually because the build directory is populated by Clion, which only support Makefile but not ninja.</p> <blockquote><p><code>idf.py</code> comes with ninja build system, which can provide better profermance. But both makefile and ninja can be generated from cmake as its backend</p></blockquote> <p>Assume that we are still working at <code>examples/get-started/hello_world/</code>. After the project gets populated by Clion there will be either <code>cmake-build-debug</code> or <code>build</code> which contains the actual build. cd to that directory.</p> <p>To flash the project onto boards we must first manually specify which UART port out board is present. Take a look at <code>ls -l | grep tty</code> and see if there is any <code>ttyUSBx</code> or <code>ttyACMx</code>.</p> <p>Then set the correct value with what we found in the previous step.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">ESPPORT</span><span class="token operator">=</span>/dev/ttyxxxx
</code></pre></div><p><code>idf.py</code> will automatically do this for us but with pure cmake it is required to be done manually.</p> <p>Finally the last step:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">make</span> flash monitor
</code></pre></div><p>The code will be compiled flashed to the board, and open a monitor to see the output. To exit the monitor please press <code>CTRL + ]</code>.</p> <h2 id="developing-chips-other-than-esp32"><a href="#developing-chips-other-than-esp32" class="header-anchor">#</a> Developing chips other than ESP32</h2> <p>ATTOW there are 5 chips that is comfirmed to be supported with ESP-IDF:</p> <ul><li>ESP32</li> <li>ESP32S2</li> <li>ESP32C3</li> <li>ESP32S3</li> <li>ESP32H2</li></ul> <p>All of them share the same set of drivers and examples (may differ).</p> <p>Back to the previous chapter where Clion opens a wizard to configure cmake profile. That window can also be opened from the buttom left corner</p> <p><img src="/assets/img/cmake_frofile_entrance.79ce6857.png" alt="cmake_profile_window"></p> <p>The only things that should change is</p> <p><img src="/assets/img/cmake_options.793057b9.png" alt="cmake_options"></p> <p>Where <code>esp32s3</code> can be replaced with the chips listed above.</p> <p><strong>DON'T</strong> press the OK button in a hurry. There still something need to do to avoid magic problems caused by cached makefile. <code>sdkconfig</code> and everything under <code>build</code> directory need to be deleted to let cmake do a fresh generation. <code>build/</code> may not exist and <code>cmake-build-debug</code> exists instead, if you forget to change build directory in Clion. Doesn't matter at all.</p> <p><img src="/assets/img/files_to_be_deleted.864a39bc.png" alt="files_to_be_deleted"></p> <p>At this point it's OK to press OK. Now you are developing for another chip.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/PilotPi/" class="prev">
        PilotPi
      </a></span> <span class="next"><a href="/notes/capture_iface_on_android_phone.html">
        使用Wireshark实时分析安卓手机的包
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7084683f.js" defer></script><script src="/assets/js/2.c61553e1.js" defer></script><script src="/assets/js/3.27e6ffee.js" defer></script>
  </body>
</html>
